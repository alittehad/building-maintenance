<!DOCTYPE html>
<html>
<head>
  <title>Post Complaint</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h2>📝 Post Your Complaint</h2>

  <input type="text" id="room" placeholder="Room No" required><br><br>
  <input type="text" id="name" placeholder="Your Name" readonly><br><br>
  <textarea id="complaint" placeholder="Describe your problem" required></textarea><br><br>
  <input type="file" id="imageInput"><br><br>
  <button onclick="submitComplaint()">📤 Post Complaint</button>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="firebase-config.js"></script>

  <script>
    let currentUserName = "";

    firebase.auth().onAuthStateChanged(user => {
      if (!user) return location.href = 'index.html';
      currentUserName = user.displayName;
      document.getElementById("name").value = currentUserName;
    });

    function submitComplaint() {
      const room = document.getElementById("room").value.trim();
      const name = currentUserName;
      const text = document.getElementById("complaint").value.trim();
      const file = document.getElementById("imageInput").files[0];
      const date = new Date().toLocaleString();

      if (!room || !text) {
        alert("Please fill all fields.");
        return;
      }

      if (file) {
        const reader = new FileReader();
        reader.onloadend = function () {
          const base64Image = reader.result.replace(/^data:image\/\w+;base64,/, "");
          fetch("https://api.imgbb.com/1/upload?key=50efc7f1c214fcb8a10324ee7256f9f4", {
            method: "POST",
            body: new URLSearchParams({ image: base64Image })
          })
          .then(res => res.json())
          .then(res => saveComplaint(room, name, text, res.data.url, date))
          .catch(() => alert("Image upload failed."));
        };
        reader.readAsDataURL(file);
      } else {
        saveComplaint(room, name, text, "", date);
      }
    }

    function saveComplaint(room, name, text, img, date) {
      firebase.database().ref("complaints").push({ room, name, text, img, date });
      alert("✅ Complaint posted successfully!");
      document.getElementById("room").value = "";
      document.getElementById("complaint").value = "";
      document.getElementById("imageInput").value = "";
    }
  </script>
</body>
</html>
