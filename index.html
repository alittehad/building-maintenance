<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Maintenance Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f0f0f0; }
    .card { background: #fff; padding: 20px; margin: 15px auto; max-width: 600px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    input, button, textarea, select { width: 100%; padding: 10px; margin: 6px 0; border-radius: 6px; border: 1px solid #ccc; }
    button { background: #007bff; color: white; border: none; cursor: pointer; font-weight: bold; }
    button:hover { background: #0056b3; }
    .admin-only, .user-only, #noticeMarquee { display: none; }
    .scroll-box { overflow: hidden; background: #fff; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); padding: 10px; margin: 10px 0; }
    .marquee { white-space: nowrap; display: inline-block; animation: scroll 15s linear infinite; }
    @keyframes scroll { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
  </style>
</head>
<body>
<h2>🏢 Maintenance Dashboard</h2>

<div id="loginSection" class="card">
  <input id="loginRoom" placeholder="Room No">
  <input id="loginPass" placeholder="Password" type="password">
  <button onclick="loginUser()">🔐 Room Login</button>
  <hr>
  <button onclick="googleLogin()">🔐 Admin Login (Google)</button>
</div>

<div id="welcomeSection" class="card">
  <h3>Welcome, <span id="userName"></span>!</h3>
  <button onclick="logout()">🚪 Logout</button>
</div>

<div class="scroll-box"><div id="noticeMarquee" class="marquee"></div></div>

<div class="card user-only">
  <h3>📅 Search My Maintenance</h3>
  <input id="searchDate" placeholder="dd-mm-yyyy">
  <button onclick="searchMyMaintenance()">Search</button>
  <div id="myMaintResults"></div>
</div>

<div class="card admin-only">
  <h3>📢 Post Notice</h3>
  <textarea id="noticeText"></textarea>
  <button onclick="postNotice()">Post</button>
</div>

<div class="card admin-only">
  <h3>🏠 Add Maintenance</h3>
  <input id="maintRoom" placeholder="Room No">
  <input id="maintPaid" type="number" placeholder="Paid ₹">
  <input id="maintDesc" placeholder="Description">
  <select id="paymentMode">
    <option value="Cash">Cash</option>
    <option value="Online">Online</option>
    <option value="Cheque">Cheque</option>
  </select>
  <button onclick="addMaintenance()">Save</button>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAHGIUaN2JMIXB7HuCM4BjXA97E0bvWYDA",
    authDomain: "al-ittehad-575a0.firebaseapp.com",
    databaseURL: "https://al-ittehad-575a0-default-rtdb.firebaseio.com",
    projectId: "al-ittehad-575a0",
    storageBucket: "al-ittehad-575a0.appspot.com",
    messagingSenderId: "797238238041",
    appId: "1:797238238041:web:89f2aa5c786c59dc374a48"
  };
  firebase.initializeApp(firebaseConfig);

  const adminEmail = "ngogrant454@gmail.com";
  let currentRoom = "";

  function loginUser() {
    const room = document.getElementById("loginRoom").value.trim();
    const pass = document.getElementById("loginPass").value.trim();
    if (!room || !pass) return alert("Fill both fields");
    firebase.database().ref(`roomUsers/${room}`).once("value").then(snap => {
      const data = snap.val();
      if (data && data.password === pass) {
        currentRoom = room;
        showUser(data.name || "Room " + room);
      } else alert("Invalid credentials");
    });
  }

  function googleLogin() {
    firebase.auth().signInWithPopup(new firebase.auth.GoogleAuthProvider())
      .then(res => {
        const email = res.user.email;
        if (email === adminEmail) showAdmin(res.user.displayName);
        else alert("Not authorized");
      });
  }

  function showUser(name) {
    document.getElementById("loginSection").style.display = "none";
    document.getElementById("userName").innerText = name;
    document.getElementById("welcomeSection").style.display = "block";
    document.querySelectorAll(".user-only").forEach(x => x.style.display = "block");
    loadNotices();
  }

  function showAdmin(name) {
    document.getElementById("loginSection").style.display = "none";
    document.getElementById("userName").innerText = name;
    document.getElementById("welcomeSection").style.display = "block";
    document.querySelectorAll(".admin-only").forEach(x => x.style.display = "block");
    loadNotices();
  }

  function logout() {
    firebase.auth().signOut().finally(() => location.reload());
  }

  function postNotice() {
    const text = document.getElementById("noticeText").value;
    firebase.database().ref("notices").push({ text });
    document.getElementById("noticeText").value = "";
    loadNotices();
  }

  function loadNotices() {
    firebase.database().ref("notices").once("value").then(snap => {
      let html = "";
      snap.forEach(child => html += `📢 ${child.val().text} &nbsp;&nbsp;&nbsp;`);
      document.getElementById("noticeMarquee").innerHTML = html || "No notices.";
      document.getElementById("noticeMarquee").style.display = "block";
    });
  }

  function addMaintenance() {
    const room = document.getElementById("maintRoom").value;
    const paid = parseInt(document.getElementById("maintPaid").value);
    const desc = document.getElementById("maintDesc").value;
    const paymentMode = document.getElementById("paymentMode").value;
    const charge = 400;
    const due = charge - paid;
    const date = new Date().toLocaleDateString("en-GB").replace(/\//g, "-");
    firebase.database().ref(`maintenance/${room}/${date}`).set({ charge, paid, due, description: desc, paymentMode, date });
    alert("Saved");
  }

  function searchMyMaintenance() {
    const date = document.getElementById("searchDate").value.trim();
    const out = document.getElementById("myMaintResults");
    if (!currentRoom) return;
    firebase.database().ref(`maintenance/${currentRoom}`).once("value").then(snap => {
      let html = "";
      const data = snap.val();
      for (let d in data) {
        if (date && d !== date) continue;
        const m = data[d];
        html += `<p><b>${d}</b> - Paid ₹${m.paid}, Due ₹${m.due}, ${m.paymentMode}, ${m.description}</p>`;
      }
      out.innerHTML = html || "No records.";
    });
  }
</script>
</body>
</html>
